<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kochi Metro Rail Document Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #0B3C46; color: #FFDF00; }
        header { background-color: #1A1F24; border-bottom: 1px solid #0B3C46; }
        header h1, header .text-gray-600, header .text-gray-400 { color: #FFDF00 !important; }
        header input { background-color: #1A1F24; border-color: #0B3C46; color: #FFDF00; }
        header input::placeholder { color: #8B8B66; }
        .sidebar { background-color: #1A1F24; }
        .sidebar a, .sidebar .text-gray-600, .sidebar .text-gray-500 { color: #FFDF00 !important; }
        .sidebar a:hover { background-color: #0B3C46 !important; }
        .sidebar .bg-blue-50 { background-color: #0B3C46 !important; }
        .sidebar .text-blue-700 { color: #FFDF00 !important; }
        .main-content { background-color: #0B3C46; }
        .main-content .text-gray-800, .main-content .text-gray-600, .main-content .text-gray-900 { color: #FFDF00 !important; }
        .bg-white { background-color: #1A1F24 !important; }
        .bg-gray-50 { background-color: #0B3C46 !important; }
        .text-gray-500, .text-gray-700, .text-gray-600 { color: #FFDF00 !important; }
        .upload-area { border: 2px dashed #2D3843; background-color: #1A1F24; }
        .upload-area.dragover { border-color: #FFDF00; background-color: #2D3843; }
        .divide-gray-200 > :not([hidden]) ~ :not([hidden]) { border-color: #0B3C46; }
        .hover\:bg-gray-50:hover { background-color: #2D3843 !important; }
        .department-safety { border-left: 4px solid #E53E3E; }
        .department-finance { border-left: 4px solid #38A169; }
        .department-engineering { border-left: 4px solid #3182CE; }
        .department-urgent { border-left: 4px solid #D69E2E; }
        .department-general { border-left: 4px solid #805AD5; }
        button, .btn { color: #FFDF00; }
        #downloadPdf { background-color: #2D3843; border: 1px solid #FFDF00; }
        #downloadPdf:hover { background-color: #3D4853; }
        svg.text-gray-400, svg.text-blue-600, svg.text-red-600 { color: #FFDF00 !important; }
        .text-blue-600 { color: #FFDF00 !important; }
        .animate-spin { border-color: #FFDF00 transparent #FFDF00 transparent !important; }
        .progress-container { width: 100%; background-color: #2D3843; border-radius: 4px; margin: 10px 0; display: none; }
        .progress-bar { height: 6px; background-color: #FFDF00; border-radius: 4px; transition: width 0.3s ease; width: 0%; }
        #analysisContent ul { list-style-type: none; padding-left: 0; }
        #analysisContent li { margin-bottom: 8px; }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); position: fixed; z-index: 50; height: 100vh; width: 256px; transition: transform 0.3s ease-in-out; }
            .sidebar.active { transform: translateX(0); }
            .main-content { margin-left: 0; width: 100%; }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <!-- UI Structure -->
    <header class="bg-white shadow-sm flex-shrink-0">
        <div class="flex items-center justify-between px-6 py-3">
            <div class="flex items-center">
                <button id="menuToggle" class="md:hidden mr-4 text-gray-600"><i class="fas fa-bars"></i></button>
                <div class="flex items-center"><div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold">KM</div><h1 class="ml-3 text-xl font-semibold">Kochi Metro Docs</h1></div>
            </div>
            <a href="/home.html" class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-700 font-bold" title="Go to Home Page">H</a>
        </div>
    </header>
    <div class="flex flex-1 overflow-hidden">
        <aside class="sidebar bg-white shadow-md w-64 flex-shrink-0"><nav class="p-4"><ul class="space-y-2"><li class="font-medium text-xs uppercase tracking-wider pl-2 mb-2">Departments</li><li><a href="#" data-category="all" class="category-link flex items-center px-4 py-2 rounded-lg bg-blue-50"><i class="fas fa-folder mr-3"></i>All Documents</a></li><li><a href="#" data-category="invoices" class="category-link flex items-center px-4 py-2 hover:bg-gray-100 rounded-lg"><i class="fas fa-file-invoice-dollar mr-3 text-green-500"></i>Invoices</a></li><li><a href="#" data-category="safety_reports" class="category-link flex items-center px-4 py-2 hover:bg-gray-100 rounded-lg"><i class="fas fa-shield-alt mr-3 text-red-500"></i>Safety Reports</a></li><li><a href="#" data-category="engineering_drawings" class="category-link flex items-center px-4 py-2 hover:bg-gray-100 rounded-lg"><i class="fas fa-drafting-compass mr-3 text-blue-500"></i>Engineering</a></li><li><a href="#" data-category="urgent" class="category-link flex items-center px-4 py-2 hover:bg-gray-100 rounded-lg"><i class="fas fa-exclamation-circle mr-3 text-yellow-500"></i>Urgent</a></li><li><a href="#" data-category="miscellaneous" class="category-link flex items-center px-4 py-2 hover:bg-gray-100 rounded-lg"><i class="fas fa-box-open mr-3 text-purple-500"></i>Miscellaneous</a></li></ul></nav></aside>
        <main class="main-content flex-1 overflow-y-auto p-6">
            <div class="bg-white rounded-xl shadow-sm p-6 mb-8">
                <h3 class="text-lg font-semibold mb-4">Upload New File</h3>
                <div id="uploadArea" class="upload-area rounded-lg p-8 text-center cursor-pointer mb-4"><i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mx-auto mb-3"></i><p>Drag & drop or <span class="font-medium text-blue-400">browse files</span></p><p class="text-sm mt-2">PDF, DOCX, TXT</p></div>
                <input type="file" id="fileInput" class="hidden" accept=".pdf,.docx,.txt">
                <div id="progressContainer"><div id="progressBar"></div></div>
                <div id="previewSection" class="hidden mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div id="filePreview" class="bg-gray-50 rounded-lg p-4"></div>
                    <div class="bg-gray-50 rounded-lg p-4"><h4 class="font-medium mb-3">AI Analysis</h4><div id="analysisContent" class="p-4 bg-white rounded-lg shadow-sm h-64 overflow-y-auto"></div><div class="mt-4 flex justify-end"><button id="downloadPdf" class="px-4 py-2 text-white rounded-lg flex items-center btn"><i class="fas fa-download mr-2"></i>Download Report</button></div></div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-semibold mb-4" id="sectionTitle">Recent Files</h3>
                <div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead><tr><th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium uppercase tracking-wider">Name</th><th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium uppercase tracking-wider">Category</th><th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium uppercase tracking-wider">Uploaded</th><th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium uppercase tracking-wider">Actions</th></tr></thead><tbody id="filesTableBody" class="bg-white divide-y divide-gray-200"></tbody></table></div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const G = id => document.getElementById(id);
            const uploadArea = G('uploadArea'), fileInput = G('fileInput');
            const previewSection = G('previewSection'), filePreview = G('filePreview'), analysisContent = G('analysisContent');
            const progressContainer = G('progressContainer'), progressBar = G('progressBar');
            const filesTableBody = G('filesTableBody');
            
            const loadFiles = async () => {
                try {
                    const response = await fetch('/files');
                    const files = await response.json();
                    displayFiles(files);
                } catch (error) {
                    filesTableBody.innerHTML = `<tr><td colspan="4" class="text-center text-red-500 p-4">Error loading files.</td></tr>`;
                }
            };

            const displayFiles = (files) => {
                if (!files || files.length === 0) {
                    filesTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-4">No documents found.</td></tr>`;
                    return;
                }
                filesTableBody.innerHTML = files.map(file => {
                    const category = file.category || 'miscellaneous';
                    const translationLink = file.has_translation
                        ? `<a href="/download/${file.translation_meta_id}" class="text-yellow-400 hover:text-yellow-600 ml-3">Download Translation</a>`
                        : '';
                    return `
                        <tr class="hover:bg-gray-50 ${getDepartmentClass(category)}">
                            <td class="px-6 py-4 whitespace-nowrap"><div class="flex items-center">${getFileIcon(file.filename)}<div class="ml-4 font-medium">${file.filename}</div></div></td>
                            <td class="px-6 py-4 whitespace-nowrap"><span class="px-2 py-1 text-xs rounded-full ${getCategoryColor(category)}">${category.replace(/_/g, ' ')}</span></td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm">${new Date(file.uploaded_at).toLocaleDateString()}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <a href="/download/${file.meta_id}" class="text-blue-400 hover:text-blue-600">Download Original</a>
                                ${translationLink}
                            </td>
                        </tr>`;
                }).join('');
            };

            const handleFileUpload = async (file) => {
                if (!file) return;
                progressContainer.style.display = 'block';
                progressBar.style.width = '0%';
                previewSection.classList.remove('hidden');
                filePreview.innerHTML = getLoadingSpinner('Preparing...');
                analysisContent.innerHTML = getLoadingSpinner('Uploading...');
                
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    const xhr = new XMLHttpRequest();
                    xhr.upload.onprogress = e => e.lengthComputable && (progressBar.style.width = `${(e.loaded / e.total) * 100}%`);
                    xhr.open('POST', '/upload', true);
                    xhr.onload = async () => {
                        if (xhr.status >= 200 && xhr.status < 300) {
                            const result = JSON.parse(xhr.responseText);
                            await displayUploadResults(file, result);
                            loadFiles();
                        } else {
                            analysisContent.innerHTML = `<p class="text-red-500">Upload failed: ${xhr.statusText}</p>`;
                        }
                        setTimeout(() => progressContainer.style.display = 'none', 1000);
                    };
                    xhr.onerror = () => { analysisContent.innerHTML = `<p class="text-red-500">A network error occurred.</p>`; };
                    xhr.send(formData);
                } catch (error) {
                    analysisContent.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
                }
            };
            
            const displayUploadResults = async (file, result) => {
                displayFilePreview(file);
                analysisContent.innerHTML = getLoadingSpinner('Generating summary...');
                
                // *** THIS IS THE FIX ***
                // Always use the original_meta_id. The backend is smart enough to find
                // the translated text if it exists. This simplifies the logic and makes it more reliable.
                const metaIdToSummarize = result.original_meta_id;
                
                const summaryRes = await fetch(`/summary/${metaIdToSummarize}`);
                const summaryData = await summaryRes.json();
                
                const summary = summaryData.summary || "Summary not available.";
                displayAnalysisContent(result, summary);
                G('downloadPdf').onclick = () => generatePDFReport(file, result, summary);
            };

            const displayFilePreview = (file) => {
                filePreview.innerHTML = `
                    <h4 class="font-medium mb-3">File Preview</h4>
                    <div class="p-4 bg-white rounded-lg shadow-sm h-64 flex items-center justify-center text-center">
                        <div>
                            <div class="w-16 h-16 rounded-lg flex items-center justify-center mx-auto mb-4 ${getFileIcon(file.name, true)}">${getFileIcon(file.name)}</div>
                            <h3 class="font-semibold">${file.name}</h3>
                            <p>${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                        </div>
                    </div>`;
            };

            const displayAnalysisContent = (result, summary) => {
                const tags = result.tags || [];
                const formattedSummary = summary.replace(/\* /g, '<li>').replace(/\n/g, '<br>').replace(/<\/li><br>/g, '</li>');
                analysisContent.innerHTML = `
                    <h4 class="font-semibold mb-2">AI Summary</h4>
                    <div class="text-sm mb-4">${formattedSummary.startsWith('<li>') ? `<ul>${formattedSummary}</ul>` : formattedSummary}</div>
                    <h4 class="font-semibold mt-4 mb-2">Classification</h4>
                    <div class="flex flex-wrap gap-2">
                        ${tags.map(tag => `<span class="px-2 py-1 ${getCategoryColor(tag)} text-xs rounded-full">${tag.replace(/_/g, ' ')}</span>`).join('') || `<span class="px-2 py-1 ${getCategoryColor('miscellaneous')} text-xs rounded-full">miscellaneous</span>`}
                    </div>`;
            };
            
            const generatePDFReport = (file, result, summary) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFillColor(11, 60, 70).rect(0, 0, 220, 30, 'F');
                doc.setFontSize(18).setTextColor(255, 223, 0).text('Kochi Metro Rail', 105, 18, { align: 'center' });
                doc.setFontSize(12).setTextColor(255, 255, 255).text('Document Analysis Report', 105, 26, { align: 'center' });
                doc.setFontSize(11).setTextColor(0,0,0).text(`File: ${file.name}`, 14, 48);
                doc.setFontSize(10).setTextColor(80,80,80).text(`Generated: ${new Date().toLocaleString()}`, 14, 54);
                
                doc.setFontSize(14).setTextColor(11,60,70).text('AI Summary', 14, 70);
                doc.line(14, 72, 45, 72);
                const summaryLines = doc.splitTextToSize(summary.replace(/\*/g, '-'), 180);
                doc.setFontSize(10).setTextColor(0,0,0).text(summaryLines, 14, 80);

                let yPos = 80 + (summaryLines.length * 5) + 10;
                doc.setFontSize(14).setTextColor(11,60,70).text('Classification', 14, yPos);
                doc.line(14, yPos+2, 55, yPos+2);
                doc.setFontSize(11).text(`Primary Category: ${(result.primary_tag || 'misc').replace(/_/g, ' ')}`, 14, yPos += 10);
                
                doc.save(`Report_${file.name.replace(/\.[^/.]+$/, "")}.pdf`);
            };

            const getDepartmentClass = c => ({ 'safety_reports': 'department-safety', 'invoices': 'department-finance', 'engineering_drawings': 'department-engineering', 'urgent': 'department-urgent', 'miscellaneous': 'department-general' })[c] || 'department-general';
            const getCategoryColor = c => ({ 'safety_reports': 'bg-red-200 text-red-800', 'invoices': 'bg-green-200 text-green-800', 'engineering_drawings': 'bg-blue-200 text-blue-800', 'urgent': 'bg-yellow-200 text-yellow-800', 'miscellaneous': 'bg-purple-200 text-purple-800' })[c] || 'bg-purple-200 text-purple-800';
            const getFileIcon = (filename, bgOnly = false) => {
                const ext = filename?.split('.').pop().toLowerCase() || '';
                const map = { 'pdf': ['fa-file-pdf', 'bg-red-100 text-red-600'], 'docx': ['fa-file-word', 'bg-blue-100 text-blue-600'], 'txt': ['fa-file-alt', 'bg-gray-100 text-gray-600'] };
                const [icon, colorClass] = map[ext] || ['fa-file', 'bg-gray-100 text-gray-600'];
                return bgOnly ? colorClass : `<i class="fas ${icon} text-2xl"></i>`;
            };

            const getLoadingSpinner = (message) => `<div class="flex items-center justify-center h-full text-center"><div class="animate-spin rounded-full h-12 w-12 border-b-2 mx-auto"></div><p class="mt-4">${message}</p></div>`;

            G('menuToggle').addEventListener('click', () => document.querySelector('.sidebar').classList.toggle('active'));
            uploadArea.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', e => handleFileUpload(e.target.files[0]));
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => {
                uploadArea.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); });
                uploadArea.classList.toggle('dragover', ['dragover', 'dragenter'].includes(evt));
            });
            uploadArea.addEventListener('drop', e => handleFileUpload(e.dataTransfer.files[0]));
            document.querySelectorAll('.category-link').forEach(link => link.addEventListener('click', e => { e.preventDefault(); loadFiles(); }));

            loadFiles();
        });
    </script>
</body>
</html>

